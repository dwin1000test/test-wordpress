machine:
  timezone: Europe/Copenhagen 
  php:
    version: 5.6.22

  # This will be added to the `/etc/hosts` file
  hosts:
    wppusher-plugin.dev: 127.0.0.1

dependencies:
  pre:
   
    # Install php mysql extension
    - gpg --recv-keys 5072E1F5
    - gpg --export 5072E1F5 > 5072E1F5.gpg
    - sudo mv 5072E1F5.gpg /etc/apt/trusted.gpg.d/
    - sudo apt-get update
    - sudo apt-get install php5-mysql
 
    # No password is required for the MySQL user `ubuntu`
    - mysql -u ubuntu -e "create database wordpress"
    
    # Use cURL to fetch WP-CLI
    - curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    
    # Make sure WP-CLI is executable
    - chmod +x wp-cli.phar
    
    # Download WordPress into `wordpress` directory
    - ./wp-cli.phar core download --allow-root --path=wordpress
    
    # Generate `wp-config.php` file
    - ./wp-cli.phar core config --allow-root --dbname=wordpress --dbuser=ubuntu --dbhost=localhost --path=wordpress
    # the wp-cli breaks if you don't use loopback IP address
    - sed -i.bak s/localhost/127.0.0.1/g wordpress/wp-config.php 

    
    # Install WordPress
    - sudo ./wp-cli.phar core install --allow-root --admin_name=admin --admin_password=admin --admin_email=admin@example.com --url=http://wppusher-plugin.dev:8080 --title=WordPress --path=wordpress
    
    # Clonse WP Pusher plugin from GitHub
    #- git clone git@github.com:petersuhm/wppusher-plugin.git wordpress/wp-content/plugins/wppusher
    
    # And use WP-CLI to activate it
    #- ./wp-cli.phar plugin activate wppusher --path=wordpress

  post:
    # Copy Apache conf into `site-available`
    #- sudo cp wppusher-plugin/apache-ci.conf /etc/apache2/sites-available
    
    # Use `a2ensite` to create a symlink for the config
    #- sudo a2ensite apache-ci.conf
    
    # Restart the Apache server
    - sudo service apache2 restart

test:
  pre:
    - git clone git://github.com/Behat/Behat.git && cd Behat
    - wget -nc https://getcomposer.org/composer.phar
    - php composer.phar install

    # Install InSpec
    - apt-get -y install ruby ruby-dev gcc make
    - gem install inspec
    #- wget https://packages.chef.io/files/stable/inspec/1.19.1/ubuntu/14.04/inspec_1.19.1-1_amd64.deb
    #- sudo dpkg -i inspec_1.19.1-1_amd64.deb

  override:
    # This is just for us to see that the WP Pusher plugin was actually installed and is active
    - ./wp-cli.phar plugin list --path=wordpress
    - ./wp-cli.phar db check --path=wordpress
   
    # Run InSpec tests
    - inspec exec tests
    # Finally, run our Behat features
    #- vendor/bin/behat
